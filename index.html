// ==============================
// ALT-FIX â€” Script global
// ==============================

// ---------- Burger menu (mobile)
(() => {
  const burger = document.querySelector('.burger');
  const menu   = document.querySelector('.menu');
  if (!burger || !menu) return;

  burger.addEventListener('click', () => {
    const open = menu.classList.toggle('open');
    burger.setAttribute('aria-expanded', String(open));
  });
})();

// ==============================
// ðŸŽµ Musique de fond (playlist + reprise entre pages)
// ==============================
(() => {
  // Les pistes de ta playlist (mets ici .mp3 ou .wav que tu as rÃ©ellement)
  const tracks = [
    'assets/music/piano-chill.wav',
    'assets/music/lofi-soft.wav',
    'assets/music/ambient-light.wav'
  ];

  let currentTrack = 0;
  let music; // sera dÃ©fini au DOMContentLoaded
  let saveTimer;

  // Raccourcis clÃ©s localStorage
  const KEY_TRACK  = 'musicTrack';
  const KEY_TIME   = 'musicTime';
  const KEY_MUTED  = 'musicMuted';
  const KEY_VOL    = 'musicVolume';

  // Charge une piste par index et lance la lecture
  function loadAndPlay(i) {
    if (!music) return;
    currentTrack = ((i % tracks.length) + tracks.length) % tracks.length; // modulo sÃ»r
    music.src = tracks[currentTrack];
    music.load();
    music.play().catch(() => {
      // Autoplay bloquÃ© tant que l'utilisateur n'a pas interagi.
      // Le bouton "Musique" dÃ©clenchera play().
    });
  }

  // Sauvegarde pÃ©riodique de lâ€™Ã©tat
  function saveState() {
    if (!music) return;
    try {
      localStorage.setItem(KEY_TRACK, String(currentTrack));
      localStorage.setItem(KEY_TIME,  String(music.currentTime || 0));
      localStorage.setItem(KEY_MUTED, String(music.muted));
      localStorage.setItem(KEY_VOL,   String(music.volume));
    } catch (_) { /* stockage plein/dÃ©sactivÃ© */ }
  }

  // Expose quelques helpers au scope global (utilisÃ©s par les boutons HTML)
  window.toggleMusic = function toggleMusic() {
    if (!music) return;
    if (music.muted) {
      music.muted = false;
      music.play().catch(() => {});
    } else {
      music.muted = true;
      music.pause();
    }
    saveState();
    // Mets Ã  jour lâ€™icÃ´ne/label du bouton si tu veux ici
    const btn = document.querySelector('button.btn.music, button[onclick*="toggleMusic"]');
    if (btn) btn.textContent = music.muted ? 'ðŸ”‡ Musique' : 'ðŸŽµ Musique';
  };

  window.setVolume = function setVolume(v) {
    if (!music) return;
    const vol = Math.min(1, Math.max(0, parseFloat(v)));
    music.volume = isNaN(vol) ? 0.2 : vol;
    if (music.volume > 0 && music.muted) music.muted = false;
    saveState();
  };

  // Initialisation une fois le DOM prÃªt
  window.addEventListener('DOMContentLoaded', () => {
    music = document.getElementById('bg-music');
    if (!music) return;

    // Volume par dÃ©faut (doux)
    music.volume = 0.2;

    // Restauration de lâ€™Ã©tat prÃ©cÃ©dent
    try {
      const savedTrack = localStorage.getItem(KEY_TRACK);
      const savedTime  = localStorage.getItem(KEY_TIME);
      const savedMuted = localStorage.getItem(KEY_MUTED);
      const savedVol   = localStorage.getItem(KEY_VOL);

      if (savedTrack !== null) {
        loadAndPlay(parseInt(savedTrack, 10) || 0);
        // Attends que la metadata soit prÃªte pour positionner le temps
        music.addEventListener('loadedmetadata', () => {
          const t = parseFloat(savedTime || '0');
          if (!isNaN(t) && t > 0 && t < (music.duration || Infinity)) {
            music.currentTime = t;
          }
          // Si non-muet prÃ©cÃ©demment, tente de lire
          if (savedMuted === 'false') {
            music.muted = false;
            music.play().catch(() => {});
          } else {
            music.muted = true;
          }
        }, { once: true });

        if (savedVol !== null) {
          const v = parseFloat(savedVol);
          if (!isNaN(v)) music.volume = Math.min(1, Math.max(0, v));
        }
      } else {
        // Pas de sauvegarde => dÃ©marre au dÃ©but
        loadAndPlay(0);
      }
    } catch {
      // Si localStorage indisponible : dÃ©marre simplement
      loadAndPlay(0);
    }

    // EnchaÃ®ne les morceaux
    music.addEventListener('ended', () => {
      loadAndPlay(currentTrack + 1);
      saveState();
    });

    // Sauvegarde lâ€™Ã©tat rÃ©guliÃ¨rement
    saveTimer = setInterval(saveState, 2000);

    // Synchronise le slider de volume si prÃ©sent
    const volInput = document.getElementById('music-volume');
    if (volInput) {
      volInput.value = String(music.volume);
      volInput.addEventListener('input', (e) => {
        window.setVolume(e.target.value);
      });
    }

    // Ajuste le label du bouton musique au chargement
    const btn = document.querySelector('button.btn.music, button[onclick*="toggleMusic"]');
    if (btn) btn.textContent = music.muted ? 'ðŸ”‡ Musique' : 'ðŸŽµ Musique';
  });

  // Nettoyage si jamais cette page dÃ©charge le script (SPA, etc.)
  window.addEventListener('beforeunload', () => {
    saveState();
    if (saveTimer) clearInterval(saveTimer);
  });
})();
